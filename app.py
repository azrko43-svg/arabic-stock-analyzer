import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import plotly.graph_objects as go

# ุชูููู ุงูุตูุญุฉ
st.set_page_config(
    page_title="ูุญูู ุงูุฃุณูู ุงูููู",
    page_icon="๐",
    layout="wide"
)

# ุชุนุฑูุจ ุงูุนููุงู
st.markdown("<h1 style='text-align: center;'>ูุญูู ุงูุฃุณูู ุงูููู</h1>", unsafe_allow_html=True)
st.markdown("<h3 style='text-align: center;'>ุฃุฏุงุฉ ููุชุญููู ุงูููู ููุฃุณูู ุจุงูุนุฑุจูุฉ</h3>", unsafe_allow_html=True)

# ุงูุดุฑูุท ุงูุฌุงูุจู ููุฅุนุฏุงุฏุงุช
with st.sidebar:
    st.header("ุฅุนุฏุงุฏุงุช ุงูุชุญููู")
    
    # ุฅุฏุฎุงู ุฑูุฒ ุงูุณูู
    ุฑูุฒ_ุงูุณูู = st.text_input("ุฑูุฒ ุงูุณูู (ูุซุงู: AAPL ูุดุฑูุฉ ุฃุจู)", value="AAPL")
    
    # ุงุฎุชูุงุฑ ุงููุชุฑุฉ ุงูุฒูููุฉ
    ูุชุฑุฉ = st.selectbox(
        "ุงููุชุฑุฉ ุงูุฒูููุฉ",
        options=["1mo", "3mo", "6mo", "1y", "2y", "5y"],
        format_func=lambda x: {
            "1mo": "ุดูุฑ ูุงุญุฏ",
            "3mo": "3 ุฃุดูุฑ",
            "6mo": "6 ุฃุดูุฑ",
            "1y": "ุณูุฉ ูุงุญุฏุฉ",
            "2y": "ุณูุชุงู",
            "5y": "5 ุณููุงุช"
        }.get(x),
        index=3
    )
    
    # ุงุฎุชูุงุฑ ููุน ุงูุชุญููู
    ููุน_ุงูุชุญููู = st.radio(
        "ุงุฎุชุฑ ููุน ุงูุชุญููู",
        ["ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ", "ุนุฑุถ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ"]
    )
    
    # ุฅุนุฏุงุฏุงุช ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ
    if ููุน_ุงูุชุญููู == "ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ":
        ูุชุฑุฉ_ูุตูุฑุฉ = st.slider("ูุชุฑุฉ ุงููุชูุณุท ุงููุชุญุฑู ุงููุตูุฑ", 5, 50, 20)
        ูุชุฑุฉ_ุทูููุฉ = st.slider("ูุชุฑุฉ ุงููุชูุณุท ุงููุชุญุฑู ุงูุทููู", 20, 200, 50)
    
    # ุฒุฑ ุชูููุฐ ุงูุชุญููู
    ุชุญููู = st.button("ุชุญููู", use_container_width=True)

# ุชุญููู ุงูุจูุงูุงุช
def ุฌูุจ_ุจูุงูุงุช(ุฑูุฒ_ุงูุณูู, ูุชุฑุฉ):
    try:
        ุจูุงูุงุช = yf.download(ุฑูุฒ_ุงูุณูู, period=ูุชุฑุฉ)
        return ุจูุงูุงุช
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช: {e}")
        return pd.DataFrame()

# ุชูููุฐ ุงูุชุญููู ุนูุฏ ุงูููุฑ ุนูู ุฒุฑ ุงูุชุญููู
if ุชุญููู:
    with st.spinner('ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...'):
        ุจูุงูุงุช = ุฌูุจ_ุจูุงูุงุช(ุฑูุฒ_ุงูุณูู, ูุชุฑุฉ)
        
    if not ุจูุงูุงุช.empty:
        st.success(f"ุชู ุชุญููู ุจูุงูุงุช {ุฑูุฒ_ุงูุณูู} ุจูุฌุงุญ!")
        
        # ุนุฑุถ ูุนูููุงุช ุฃุณุงุณูุฉ ุนู ุงูุณูู
        if len(ุจูุงูุงุช) > 1:
            col1, col2 = st.columns(2)
            with col1:
                st.metric("ุขุฎุฑ ุณุนุฑ ุฅุบูุงู", f"{ุจูุงูุงุช['Close'].iloc[-1]:.2f}")
            with col2:
                ุชุบููุฑ = ุจูุงูุงุช['Close'].iloc[-1] - ุจูุงูุงุช['Close'].iloc[-2]
                ูุณุจุฉ_ุงูุชุบููุฑ = (ุชุบููุฑ / ุจูุงูุงุช['Close'].iloc[-2]) * 100
                st.metric("ุงูุชุบูุฑ ุงููููู", f"{ุชุบููุฑ:.2f}", f"{ูุณุจุฉ_ุงูุชุบููุฑ:.2f}%")
        
        # ุนุฑุถ ุงูุชุญููู ุงููุทููุจ
        if ููุน_ุงูุชุญููู == "ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ":
            # ุญุณุงุจ ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ
            ุจูุงูุงุช[f'MA_{ูุชุฑุฉ_ูุตูุฑุฉ}'] = ุจูุงูุงุช['Close'].rolling(window=ูุชุฑุฉ_ูุตูุฑุฉ).mean()
            ุจูุงูุงุช[f'MA_{ูุชุฑุฉ_ุทูููุฉ}'] = ุจูุงูุงุช['Close'].rolling(window=ูุชุฑุฉ_ุทูููุฉ).mean()
            
            # ุฑุณู ุจูุงูู
            fig = go.Figure()
            
            # ุฅุถุงูุฉ ุณุนุฑ ุงูุฅุบูุงู
            fig.add_trace(go.Scatter(
                x=ุจูุงูุงุช.index,
                y=ุจูุงูุงุช['Close'],
                mode='lines',
                name='ุณุนุฑ ุงูุฅุบูุงู',
                line=dict(color='black', width=2)
            ))
            
            # ุฅุถุงูุฉ ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ
            fig.add_trace(go.Scatter(
                x=ุจูุงูุงุช.index,
                y=ุจูุงูุงุช[f'MA_{ูุชุฑุฉ_ูุตูุฑุฉ}'],
                mode='lines',
                name=f'ุงููุชูุณุท ุงููุชุญุฑู {ูุชุฑุฉ_ูุตูุฑุฉ}',
                line=dict(color='blue', width=1.5)
            ))
            
            fig.add_trace(go.Scatter(
                x=ุจูุงูุงุช.index,
                y=ุจูุงูุงุช[f'MA_{ูุชุฑุฉ_ุทูููุฉ}'],
                mode='lines',
                name=f'ุงููุชูุณุท ุงููุชุญุฑู {ูุชุฑุฉ_ุทูููุฉ}',
                line=dict(color='red', width=1.5)
            ))
            
            # ุชุนุฏูู ุงูุชุฎุทูุท
            fig.update_layout(
                title=f'ุชุญููู ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ ูู {ุฑูุฒ_ุงูุณูู}',
                xaxis_title='ุงูุชุงุฑูุฎ',
                yaxis_title='ุงูุณุนุฑ',
                template='plotly_white',
                height=600
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # ุนุฑุถ ุงูุชูุณูุฑ
            with st.expander("ุชูุณูุฑ ุงูุชุญููู"):
                st.markdown("""
                ### ุชูุณูุฑ ุชุญููู ุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ
                
                - ุนูุฏูุง ูุชูุงุทุน ุงููุชูุณุท ุงููุตูุฑ ููู ุงููุชูุณุท ุงูุทููู: ุฅุดุงุฑุฉ ุดุฑุงุก ูุญุชููุฉ
                - ุนูุฏูุง ูุชูุงุทุน ุงููุชูุณุท ุงููุตูุฑ ุชุญุช ุงููุชูุณุท ุงูุทููู: ุฅุดุงุฑุฉ ุจูุน ูุญุชููุฉ
                
                **ูุตุงุฆุญ ููุชุฏุงูู**:
                - ุงุชุฌุงู ุตุงุนุฏ: ุนูุฏูุง ูููู ุงููุชูุณุท ุงููุตูุฑ ููู ุงููุชูุณุท ุงูุทููู
                - ุงุชุฌุงู ูุงุจุท: ุนูุฏูุง ูููู ุงููุชูุณุท ุงููุตูุฑ ุชุญุช ุงููุชูุณุท ุงูุทููู
                """)
        
        elif ููุน_ุงูุชุญููู == "ุนุฑุถ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ":
            st.subheader("ุจูุงูุงุช ุงูุณูู")
            st.dataframe(ุจูุงูุงุช.tail(20))
    else:
        st.warning(f"ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ููุฑูุฒ {ุฑูุฒ_ุงูุณูู}. ูุฑุฌู ุงูุชุญูู ูู ุฑูุฒ ุงูุณูู ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.")
else:
    st.info("ุฃุฏุฎู ุฑูุฒ ุงูุณูู ูุงุถุบุท ุนูู ุฒุฑ 'ุชุญููู' ููุจุฏุก.")
